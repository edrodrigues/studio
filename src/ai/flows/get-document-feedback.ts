'use server';
/**
 * @fileOverview Provides detailed feedback on uploaded documents using a customizable system prompt.
 *
 * - getDocumentFeedback - A function that handles the feedback generation process.
 * - GetDocumentFeedbackInput - The input type for the getDocumentfeedback function.
 * - GetDocumentFeedbackOutput - The return type for the getDocumentFeedback function.
 */

import {ai} from '@/ai/genkit';
import {z} from 'genkit';

const DocumentInputSchema = z.object({
  name: z.string().describe('The name of the file.'),
  dataUri: z.string().describe("The file content as a data URI. Expected format: 'data:<mimetype>;base64,<encoded_data>'."),
});

const GetDocumentFeedbackInputSchema = z.object({
  systemPrompt: z.string().describe('The customizable system prompt to guide the AI feedback.'),
  documents: z.array(DocumentInputSchema).describe('An array of documents to be analyzed.'),
});

export type GetDocumentFeedbackInput = z.infer<typeof GetDocumentFeedbackInputSchema>;

const GetDocumentFeedbackOutputSchema = z.object({
  feedback: z.string().describe('The detailed feedback generated by the AI in Markdown format.'),
});

export type GetDocumentFeedbackOutput = z.infer<typeof GetDocumentFeedbackOutputSchema>;


export async function getDocumentFeedback(input: GetDocumentFeedbackInput): Promise<GetDocumentFeedbackOutput> {
  return getDocumentFeedbackFlow(input);
}

const getDocumentFeedbackPrompt = ai.definePrompt({
  name: 'getDocumentFeedbackPrompt',
  input: {schema: GetDocumentFeedbackInputSchema},
  output: {schema: GetDocumentFeedbackOutputSchema},
  prompt: `{{systemPrompt}}

Analise os seguintes documentos e forneÃ§a um feedback detalhado com base no prompt do sistema.

{{#each documents}}
### Documento: {{name}}
{{media url=dataUri}}
---
{{/each}}
`,
});


const getDocumentFeedbackFlow = ai.defineFlow(
  {
    name: 'getDocumentFeedbackFlow',
    inputSchema: GetDocumentFeedbackInputSchema,
    outputSchema: GetDocumentFeedbackOutputSchema,
  },
  async (input) => {
    const {output} = await getDocumentFeedbackPrompt(input);
    return output!;
  }
);
